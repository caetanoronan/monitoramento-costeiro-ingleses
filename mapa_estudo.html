<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa - √Årea de Estudo | Praia dos Ingleses</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Montserrat", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1a1f3a 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    header {
      text-align: center;
      padding: 20px 0;
      border-bottom: 2px solid rgba(44, 162, 95, 0.3);
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 8px;
      color: #99d8c9;
    }
    .subtitle {
      font-size: 1.1rem;
      color: #94a3b8;
      margin-bottom: 10px;
    }
    .badge {
      display: inline-block;
      background: rgba(44, 162, 95, 0.2);
      border: 1px solid #2ca25f;
      color: #99d8c9;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .view-selector {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .view-btn {
      background: rgba(44, 162, 95, 0.15);
      border: 1px solid rgba(44, 162, 95, 0.5);
      color: #99d8c9;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    .view-btn.active {
      background: rgba(44, 162, 95, 0.4);
      box-shadow: 0 0 10px rgba(44, 162, 95, 0.4);
    }
    .view-btn:hover {
      background: rgba(44, 162, 95, 0.3);
    }
    .content {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 20px;
      flex: 1;
    }
    #map {
      width: 100%;
      height: 600px;
      border-radius: 12px;
      border: 2px solid rgba(44, 162, 95, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    .sidebar {
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(44, 162, 95, 0.2);
      border-radius: 12px;
      padding: 20px;
      backdrop-filter: blur(10px);
      overflow-y: auto;
      max-height: 600px;
    }
    .sidebar h3 {
      color: #99d8c9;
      font-size: 1rem;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(44, 162, 95, 0.3);
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    .legend-color {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      flex-shrink: 0;
    }
    .color-polygon { background: rgba(44, 162, 95, 0.3); }
    .color-center { background: #2ca25f; }
    .color-buffer { background: rgba(34, 211, 238, 0.55); }
    .color-work { background: #f59e0b; }
    .info-box {
      background: rgba(44, 162, 95, 0.1);
      border-left: 3px solid #99d8c9;
      padding: 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-top: 15px;
      line-height: 1.6;
    }
    .info-box strong { color: #99d8c9; }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    button {
      background: rgba(44, 162, 95, 0.2);
      border: 1px solid #2ca25f;
      color: #99d8c9;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
      flex: 1;
      min-width: 100px;
    }
    button:hover {
      background: rgba(44, 162, 95, 0.4);
      box-shadow: 0 0 12px rgba(44, 162, 95, 0.3);
    }
    footer {
      text-align: center;
      padding: 20px 0;
      border-top: 1px solid rgba(44, 162, 95, 0.2);
      font-size: 0.9rem;
      color: #94a3b8;
    }
    .leaflet-popup-content {
      color: #0f172a;
      font-family: "Montserrat", sans-serif;
    }
    .leaflet-popup-close-button { color: #666; }
    @media (max-width: 768px) {
      .content { grid-template-columns: 1fr; }
      #map { height: 400px; }
      h1 { font-size: 1.5rem; }
      .sidebar { max-height: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>√Årea de Estudo - Praia dos Ingleses</h1>
      <p class="subtitle">Monitoramento Aerofotogram√©trico da Din√¢mica Costeira</p>
      <span class="badge">Florian√≥polis/SC ‚Ä¢ IFSC</span>
    </header>

    <div class="view-selector">
      <button class="view-btn active" onclick="setMapView('study')">üìç Vista de Estudo</button>
      <button class="view-btn" onclick="setMapView('contextual')">üèóÔ∏è Contexto da Obra</button>
      <button class="view-btn" onclick="setMapView('satellite')" style="margin-left:auto;">üõ∞Ô∏è Sat√©lite</button>
    </div>

    <div class="content">
      <div id="map"></div>
      
      <div class="sidebar">
        <h3 id="legendTitle">Legenda - Estudo</h3>
        
        <div id="legendContent">
          <div class="legend-item">
            <div class="legend-color color-center"></div>
            <span>Centro de estudo (marcador)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-polygon"></div>
            <span>√Årea de estudo (pol√≠gono QGIS)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-buffer"></div>
            <span>Zona de influ√™ncia (dunas QGIS)</span>
          </div>
        </div>

        <div class="info-box">
          <strong>üìç Coordenadas:</strong><br>
          27.444¬∞ S, 48.390¬∞ W<br>
          <strong>üìè Extens√£o:</strong><br>
          ~3 km (Rio Capivari - Canto Sul)<br>
          <strong>üìä Cobertura:</strong><br>
          Praia dos Ingleses + dunas urbanas<br>
          <strong>üì∑ Par√¢metros SfM:</strong><br>
          GSD ‚â§ 3 cm, 80/70% recobrimento
        </div>

        <div class="controls">
          <button onclick="zoomArea()">üéØ Zoom</button>
          <button onclick="toggleDunes()" id="dunesToggle">üåæ Dunas: ON</button>
        </div>
      </div>
    </div>

    <footer>
      Projeto de Pesquisa e Extens√£o ¬∑ IFSC-Florian√≥polis ¬∑ Mapa Interativo v2.0
    </footer>
  </div>

  <script>
    const center = [-27.444, -48.390];
    let currentView = 'study';
    let satelliteLayer;
    let currentTileLayer;
    
    const map = L.map('map', {
      minZoom: 12,
      maxZoom: 19
    }).setView(center, 14);

    // Camada padr√£o
    currentTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 19
    }).addTo(map);

    // Camada Sat√©lite
    satelliteLayer = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: '¬© Esri', maxZoom: 19 }
    );

    // ===== CAMADA 1: ESTUDO =====
    // Marcador central removido a pedido; apenas pol√≠gonos ser√£o exibidos

    // GeoJSON oficiais (exportados do QGIS)
    const praiaGeojson = {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-48.4030708888946,-27.413774103954196],[-48.4026001922375,-27.41335626351704],[-48.40252174279466,-27.413077702347575],[-48.39671648402389,-27.42526409658788],[-48.39224486578156,-27.43062568403058],[-48.38596891035372,-27.43772764567393],[-48.37694722442619,-27.441905056691123],[-48.36863158348428,-27.44406332375268],[-48.36871003292715,-27.446221548594046],[-48.379928303254424,-27.44336711318444],[-48.390989674695994,-27.436683268210196],[-48.399226866195036,-27.427144163386348],[-48.4045614283087,-27.415445449898332],[-48.4030708888946,-27.413774103954196]]]},"properties":{"id":1}}],"crs":{"type":"name","properties":{"name":"EPSG:4326"}}};

    const dunasGeojson = {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-48.375358623208434,-27.443897974140526],[-48.37321106971048,-27.444132944567873],[-48.36966123242163,-27.44320176252889],[-48.36797456940039,-27.446613157446855],[-48.36854332786105,-27.447796677974615],[-48.36938665937165,-27.448440647045185],[-48.36885712563244,-27.449484913222342],[-48.37072029990007,-27.45021589366396],[-48.371092934753605,-27.450529169513114],[-48.37521153050312,-27.459613782049356],[-48.37607447437447,-27.462537406192258],[-48.37717276657434,-27.463024669344843],[-48.378349508217056,-27.462815842543154],[-48.37780036211712,-27.461493263612926],[-48.3790555532027,-27.460588332044864],[-48.3790555532027,-27.45968339304899],[-48.37897710375984,-27.457038144166052],[-48.3778003621171,-27.4532441895991],[-48.37691780588507,-27.451712648024163],[-48.376819744081516,-27.450268106367275],[-48.37689819352436,-27.449014994666026],[-48.37656478339228,-27.445159846488703],[-48.37695703060652,-27.44404591854203],[-48.376015637292355,-27.443750029540652],[-48.375270367585294,-27.443837055799907],[-48.375358623208434,-27.443897974140526]]]},"properties":{"id":3}}],"crs":{"type":"name","properties":{"name":"EPSG:4326"}}};

    const areaPolygon = L.geoJSON(praiaGeojson, {
      style: {
        color: '#2ca25f',
        weight: 2,
        opacity: 0.7,
        fillColor: '#2ca25f',
        fillOpacity: 0.18,
        dashArray: '5, 5'
      }
    });

    areaPolygon.bindPopup(
      '<div style="text-align:center;"><strong>√Årea de Estudo</strong><br>' +
      'Extens√£o: ~3 km (Rio Capivari - Canto Sul)<br>' +
      'Cobertura: 80/70% recobrimento<br>' +
      '<strong>GSD ‚â§ 3 cm</strong><br>' +
      'Entregas: GeoTIFF, MDS, DoD, shapefiles</div>'
    );

    const dunesLayer = L.geoJSON(dunasGeojson, {
      style: {
        color: '#0891b2',        // contorno ciano forte
        weight: 1.6,
        opacity: 0.9,
        fillColor: '#67e8f9',    // preenchimento ciano claro
        fillOpacity: 0.38,
        dashArray: '2, 4'
      }
    });

    // Buffer de contexto (ex.: 100 m) ao redor da √°rea da obra
    const bufferGeojson = turf.buffer(praiaGeojson, 100, { units: 'meters' });
    const bufferLayer = L.geoJSON(bufferGeojson, {
      style: {
        color: '#22d3ee',
        weight: 1.2,
        opacity: 0.8,
        fillColor: '#22d3ee',
        fillOpacity: 0.12,
        dashArray: '6, 4'
      }
    });

    dunesLayer.bindPopup(
      '<div><strong>Zona de Influ√™ncia (Dunas)</strong><br>' +
      'Contexto urbano e ambiental<br>' +
      'Din√¢mica de mar√© e eros√£o</div>'
    );

    // Limite de extens√£o para navega√ß√£o
    const boundsAll = L.featureGroup([areaPolygon, dunesLayer, bufferLayer]).getBounds();
    map.setMaxBounds(boundsAll.pad(0.2));

    const studyLayer = L.featureGroup();
    areaPolygon.addTo(studyLayer);

    // camada dunas control√°vel
    let dunesVisible = true;
    dunesLayer.addTo(map);

    // ===== CAMADA 2: CONTEXTO DA OBRA =====
    const workArea = L.geoJSON(praiaGeojson, {
      style: {
        color: '#f59e0b',
        weight: 2.5,
        opacity: 0.8,
        fillColor: '#f59e0b',
        fillOpacity: 0.25
      }
    });

    workArea.bindPopup(
      '<div style="text-align:center;"><strong>üèóÔ∏è √Årea Alargada (2023)</strong><br>' +
      '<strong>Largura antes:</strong> 5-15 metros<br>' +
      '<strong>Largura ap√≥s:</strong> 35-40 metros<br>' +
      '<strong>Volume:</strong> ~3 km¬≥ de areia<br>' +
      '<strong>Fonte:</strong> Jazida a ~1 km da costa<br>' +
      '<strong>Investimento:</strong> ~R$ 18 milh√µes<br>' +
      '<strong>Status:</strong> Finalizado - Mar√ßo 2023</div>'
    );

    const contextualLayer = L.featureGroup();
    workArea.addTo(contextualLayer);

    studyLayer.addTo(map);

    // Controle de vista
    function setMapView(view) {
      currentView = view;

      // Atualizar bot√µes
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Remover camadas anteriores
      map.removeLayer(studyLayer);
      if (map.hasLayer(contextualLayer)) map.removeLayer(contextualLayer);
      if (map.hasLayer(satelliteLayer)) map.removeLayer(satelliteLayer);
      if (map.hasLayer(dunesLayer)) map.removeLayer(dunesLayer);
      if (map.hasLayer(bufferLayer)) map.removeLayer(bufferLayer);

      if (view === 'study') {
        studyLayer.addTo(map);
        if (dunesVisible) dunesLayer.addTo(map);
        document.getElementById('legendTitle').textContent = 'Legenda - Estudo';
        document.getElementById('legendContent').innerHTML = `
          <div class="legend-item">
            <div class="legend-color color-polygon"></div>
            <span>√Årea de estudo (pol√≠gono QGIS)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-buffer"></div>
            <span>Zona de influ√™ncia (dunas QGIS)</span>
          </div>
        `;
        zoomArea();
      } else if (view === 'contextual') {
        contextualLayer.addTo(map);
        bufferLayer.addTo(map);
        if (dunesVisible) dunesLayer.addTo(map);
        document.getElementById('legendTitle').textContent = 'Legenda - Obra (2023)';
        document.getElementById('legendContent').innerHTML = `
          <div class="legend-item">
            <div class="legend-color color-work"></div>
            <span>√Årea alargada</span>
          </div>
          <div class="legend-item">
            <div class="legend-color color-buffer"></div>
            <span>Buffer 100 m</span>
          </div>
        `;
        zoomArea();
      } else if (view === 'satellite') {
        satelliteLayer.addTo(map);
        studyLayer.addTo(map);
        if (dunesVisible) dunesLayer.addTo(map);
        document.getElementById('legendTitle').textContent = 'Legenda - Sat√©lite';
        document.getElementById('legendContent').innerHTML = `
          <div class="legend-item">
            <span><strong>Visualiza√ß√£o:</strong> Imagem Esri</span>
          </div>
          <p style="font-size:0.8rem;color:#94a3b8;margin-top:10px;">
            Sobreposi√ß√£o da √°rea de estudo com imageamento de sat√©lite para contexto geogr√°fico.
          </p>
        `;
        zoomArea();
      }
    }

        function zoomArea() {
          const layers = [areaPolygon];
          if (map.hasLayer(dunesLayer) && dunesVisible) layers.push(dunesLayer);
          if (map.hasLayer(bufferLayer)) layers.push(bufferLayer);
          const fg = L.featureGroup(layers);
          const bounds = fg.getBounds();
          map.fitBounds(bounds.pad(0.05));
        }
        setTimeout(() => zoomArea(), 500);

        function toggleDunes() {
          dunesVisible = !dunesVisible;
          if (map.hasLayer(dunesLayer)) map.removeLayer(dunesLayer);
          if (dunesVisible) dunesLayer.addTo(map);
          document.getElementById('dunesToggle').textContent = dunesVisible ? 'üåæ Dunas: ON' : 'üåæ Dunas: OFF';
        }

    // Escala
    L.control.scale({ imperial: false, metric: true }).addTo(map);

    // Rosa dos Ventos (Compass Rose)
    L.Control.CompassRose = L.Control.extend({
      onAdd: function(map) {
        const container = L.DomUtil.create('div');
        container.innerHTML = `
          <svg width="120" height="120" viewBox="0 0 120 120" style="background:rgba(17, 24, 39, 0.85);border-radius:8px;border:1px solid rgba(44, 162, 95, 0.3);padding:8px;">
            <!-- C√≠rculo externo -->
            <circle cx="60" cy="60" r="55" fill="none" stroke="rgba(44, 162, 95, 0.4)" stroke-width="1"/>
            
            <!-- Pontos cardeais principais (N, S, L, O) -->
            <!-- Norte (N) - Tri√¢ngulo vermelho -->
            <g id="north">
              <polygon points="60,15 65,35 55,35" fill="#ef4444" opacity="0.9"/>
              <text x="60" y="10" font-size="14" font-weight="bold" fill="#ef4444" text-anchor="middle" font-family="Arial, sans-serif">N</text>
            </g>
            
            <!-- Sul (S) -->
            <g id="south">
              <polygon points="60,105 55,85 65,85" fill="#94a3b8" opacity="0.7"/>
              <text x="60" y="118" font-size="14" font-weight="bold" fill="#94a3b8" text-anchor="middle" font-family="Arial, sans-serif">S</text>
            </g>
            
            <!-- Leste (L) -->
            <g id="east">
              <polygon points="105,60 85,55 85,65" fill="#94a3b8" opacity="0.7"/>
              <text x="110" y="65" font-size="14" font-weight="bold" fill="#94a3b8" text-anchor="middle" font-family="Arial, sans-serif">L</text>
            </g>
            
            <!-- Oeste (O) -->
            <g id="west">
              <polygon points="15,60 35,55 35,65" fill="#94a3b8" opacity="0.7"/>
              <text x="10" y="65" font-size="14" font-weight="bold" fill="#94a3b8" text-anchor="middle" font-family="Arial, sans-serif">O</text>
            </g>
            
            <!-- Pontos intermedi√°rios (NE, SE, SW, NW) - linhas delgadas -->
            <line x1="60" y1="60" x2="82" y2="38" stroke="rgba(153, 216, 201, 0.3)" stroke-width="0.5"/>
            <line x1="60" y1="60" x2="82" y2="82" stroke="rgba(153, 216, 201, 0.3)" stroke-width="0.5"/>
            <line x1="60" y1="60" x2="38" y2="82" stroke="rgba(153, 216, 201, 0.3)" stroke-width="0.5"/>
            <line x1="60" y1="60" x2="38" y2="38" stroke="rgba(153, 216, 201, 0.3)" stroke-width="0.5"/>
            
            <!-- Linhas dos pontos cardeais principais -->
            <line x1="60" y1="60" x2="60" y2="20" stroke="rgba(44, 162, 95, 0.5)" stroke-width="1.5"/>
            <line x1="60" y1="60" x2="60" y2="100" stroke="rgba(44, 162, 95, 0.3)" stroke-width="1"/>
            <line x1="60" y1="60" x2="100" y2="60" stroke="rgba(44, 162, 95, 0.3)" stroke-width="1"/>
            <line x1="60" y1="60" x2="20" y2="60" stroke="rgba(44, 162, 95, 0.3)" stroke-width="1"/>
            
            <!-- Centro -->
            <circle cx="60" cy="60" r="3" fill="#99d8c9"/>
          </svg>
        `;
        
        // Estilos
        container.style.backgroundColor = 'transparent';
        container.style.border = 'none';
        container.style.width = 'auto';
        container.style.height = 'auto';
        container.style.padding = '5px';
        
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.disableScrollPropagation(container);
        
        return container;
      }
    });

    L.control.compassRose = function(opts) {
      return new L.Control.CompassRose(opts);
    };

    // Adicionar rosa dos ventos ao mapa (canto superior direito)
    L.control.compassRose({ position: 'topright' }).addTo(map);
  </script>
</body>
</html>
